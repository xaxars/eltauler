<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#c9a227">
    <meta name="description" content="Entrenador d'escacs en català amb IA adaptativa, missions diàries i sistema de progrés">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="El Tauler">
    
    <title>El Tauler - Entrenador d'Escacs</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=1.0.4">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="novaicon.png">
    <link rel="icon" type="image/png" href="novaicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Chessboard CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <style>
        :root {
            --bg-dark: #1a1410;
            --bg-card: #2d241c;
            --bg-warm: #3d322a;
            --accent-gold: #c9a227;
            --accent-green: #4a7c59;
            --accent-purple: #9c27b0;
            --accent-blue: #1976d2;
            --text-primary: #f4e4bc;
            --text-secondary: #a89a8a;
            --severity-low: #ffd700;
            --severity-med: #ff8c00;
            --severity-high: #ff0000;
            --streak-fire: #d4763b;
            --star-gold: #ffd700;
        }
                body.epaper-mode {
            --bg-dark: #f2f2f2;
            --bg-card: #e6e6e6;
            --bg-warm: #e6e6e6;
            --accent-gold: #444;
            --accent-green: #555;
            --accent-purple: #555;
            --accent-blue: #555;
            --text-primary: #222;
            --text-secondary: #444;
            --severity-low: #555;
            --severity-med: #666;
            --severity-high: #777;
            --streak-fire: #444;
            --star-gold: #555;
            background: #f2f2f2 !important;
            color: #222;
            filter: saturate(0) contrast(0.95);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0ms !important; scroll-behavior: auto !important; }
        }
   
        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #251c15 50%, var(--bg-dark) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow-x: hidden;
        }
        body.epaper-mode *,
        body.epaper-mode *::before,
        body.epaper-mode *::after {
            animation: none !important;
            transition: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
        }
        body.epaper-mode {
            background: #f2f2f2;
        }
        body.epaper-mode img, body.epaper-mode svg { filter: grayscale(100%); }
        body.epaper-mode #app-container { filter: none; }
        
        #app-container { position: relative; z-index: 1; max-width: 480px; width: 100%; }
        body.device-tablet #app-container { max-width: 760px; }
        body.device-desktop #app-container { max-width: 1100px; }

        body.device-mobile { padding: 0; align-items: flex-start; }
        body.device-mobile #app-container { max-width: 100vw; width: 100vw; }
        body.device-mobile #game-screen { padding: 0 0 10px; }
        body.device-mobile .header,
        body.device-mobile .precision-panel,
        body.device-mobile .controls { margin-left: 8px; margin-right: 8px; border-radius: 12px; }
        body.device-mobile .header { padding: 10px; margin-top: 8px; margin-bottom: 8px; }
        body.device-mobile .header-title { font-size: 1.05rem; margin-bottom: 6px; }
        body.device-mobile .game-info { font-size: 0.78rem; gap: 6px; }
        body.device-mobile .precision-panel { padding: 10px; gap: 10px; margin-bottom: 8px; }
        body.device-mobile .precision-stat { min-width: 56px; }
        body.device-mobile .precision-value { font-size: 1.15rem; }
        body.device-mobile .board-container { margin: 0; }
        body.device-mobile #myBoard { width: 100vw; max-width: 100vw; }
        body.device-mobile .controls { padding: 10px; margin-top: 8px; }
        body.device-mobile .status-message { font-size: 0.9rem; margin-bottom: 10px; }
        body.device-mobile .game-buttons .btn { padding: 12px 8px; font-size: 0.82rem; }
        body.device-mobile table.league-table { min-width: 520px; }
        body.device-mobile .league-table thead th, body.device-mobile .league-table tbody td { padding: 8px 6px; }
        body.device-mobile .league-table thead th { font-size: 0.74rem; }
        body.device-mobile .league-table tbody td { font-size: 0.86rem; }
        
        #start-screen, #stats-screen {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
            text-align: center;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }
        body.epaper-mode #start-screen, body.epaper-mode #stats-screen {
            background: var(--bg-card);
            border: 1px solid #cfcfcf;
            box-shadow: none;
        }
        
        .app-logo { font-size: 2.5rem; margin-bottom: 5px; }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.7rem;
            color: var(--accent-gold);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        body.epaper-mode h1 { color: #222; }  
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .highlight-hint {
            box-shadow: inset 0 0 5px 4px var(--accent-purple) !important;
            background-color: rgba(156, 39, 176, 0.4) !important;
            animation: pulse-purple 1.5s infinite;
        }
        body.epaper-mode .highlight-hint {
            box-shadow: inset 0 0 0 3px #5c5c5c !important;
            background-color: #d1d1d1 !important;
            background-image: repeating-linear-gradient(
                45deg,
                #d1d1d1 0,
                #d1d1d1 6px,
                #9e9e9e 6px,
                #9e9e9e 12px
            ) !important;
        }
        
        @keyframes pulse-purple {
            0% { box-shadow: inset 0 0 5px 4px var(--accent-purple); }
            50% { box-shadow: inset 0 0 10px 6px var(--accent-purple); }
            100% { box-shadow: inset 0 0 5px 4px var(--accent-purple); }
        }

        /* STATS */
        .stats-row { display: flex; justify-content: center; gap: 10px; margin: 12px 0; }
        .stat-box {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(201, 162, 39, 0.3);
            border-radius: 12px;
            padding: 10px 12px;
            min-width: 90px;
            flex: 1;
        }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 3px; }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; }
        .elo-value { color: var(--accent-gold); }
        .streak-value { color: var(--streak-fire); }
        .stars-value { color: var(--star-gold); text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        
        .resign-modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }
        
        .streak-status { font-size: 0.6rem; margin-top: 3px; padding: 2px 6px; border-radius: 8px; display: inline-block; }
        .streak-done { background: rgba(74, 124, 89, 0.3); color: var(--accent-green); }
        .streak-pending { background: rgba(212, 118, 59, 0.2); color: var(--streak-fire); }
        
        /* MISSIONS */
        .missions-panel {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
            text-align: left;
        }
        .missions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .missions-title { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--accent-gold); }
        .badges-btn {
            background: rgba(255,215,0,0.15); border: 1px solid var(--star-gold); color: var(--star-gold);
            padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; cursor: pointer; font-family: 'Crimson Pro', serif;
        }
        .mission-item {
            display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 6px;
            background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid var(--text-secondary);
        }
        .mission-item.completed { border-left-color: var(--accent-green); opacity: 0.8; background: rgba(74, 124, 89, 0.1); }

        .mission-stars { font-size: 0.9rem; color: var(--star-gold); width: 54px; text-align: center; opacity: 0.9; }
        .mission-text { flex: 1; font-size: 0.85rem; color: var(--text-primary); }
        .mission-progress { font-size: 0.72rem; color: var(--text-secondary); opacity: 0.9; margin-top: 2px; }
        .mission-check { font-size: 1.1rem; color: var(--star-gold); display: none; text-shadow: 0 0 5px var(--star-gold); }
        .mission-item.completed .mission-check { display: block; }

        .mission-trophies { font-size: 0.9rem; text-align: right; min-width: 70px; opacity: 0.95; }
        .mission-trophies.empty { opacity: 0.25; }

                .epaper-toggle {
            position: relative;
            width: 54px;
            height: 30px;
        }
        .epaper-toggle input { opacity: 0; width: 0; height: 0; }
        .epaper-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0;
            right: 0; bottom: 0;
            background-color: #b5b5b5;
            transition: 0.2s;
            border-radius: 30px;
            border: 1px solid #cfcfcf;
        }
        .epaper-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: #f2f2f2;
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .epaper-toggle input:checked + .epaper-slider {
            background-color: #9d9d9d;
            box-shadow: inset 0 0 0 1px #cfcfcf;
        }
        .epaper-toggle input:checked + .epaper-slider:before {
            transform: translateX(22px);
            background-color: #e6e6e6;
        }

        /* CONFIGURACIÓ */
        .settings-panel {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0 16px;
            text-align: left;
        }
        .settings-title { font-family: 'Cinzel', serif; font-size: 0.95rem; color: var(--accent-gold); margin-bottom: 10px; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .setting-label { font-size: 0.85rem; color: var(--text-primary); }
        .select-control {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 10px;
            font-family: 'Crimson Pro', serif;
            font-size: 0.9rem;
        }
        .text-input {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 10px;
            font-family: 'Crimson Pro', serif;
            font-size: 0.9rem;
            flex: 1 1 auto;
            min-width: 160px;
        }
        .setting-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .setting-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 56px;
            text-align: right;
        }
        body.epaper-mode .select-control { background: #e6e6e6; border: 1px solid #cfcfcf; color: #222; }
        body.epaper-mode .text-input { background: #e6e6e6; border: 1px solid #cfcfcf; color: #222; }
        .setting-help { margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.25; }
        body.epaper-mode .header,
        body.epaper-mode .precision-panel,
        body.epaper-mode .controls,
        body.epaper-mode .missions-panel,
        body.epaper-mode .settings-panel,
        body.epaper-mode .chart-container,
        body.epaper-mode .stat-card,
        body.epaper-mode .danger-zone,
        body.epaper-mode .league-meta,
        body.epaper-mode .league-table-wrap,
        body.epaper-mode .mission-item,
        body.epaper-mode .bundle-item,
        body.epaper-mode .drill-item,
        body.epaper-mode .bundle-section,
        body.epaper-mode .review-chip,
        body.epaper-mode .controls .status-message {
            background: #e6e6e6 !important;
            border-color: #cfcfcf !important;
            box-shadow: none !important;
            color: #222;
        }
        body.epaper-mode .mission-item { border-left-color: #cfcfcf !important; }
        body.epaper-mode .stat-card-value { color: #222; }
        body.epaper-mode .stat-card-label,
        body.epaper-mode .setting-help,
        body.epaper-mode .subtitle,
        body.epaper-mode .review-highlight { color: #444; }
 
        /* TV GRID */
        .tv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .tv-actions {
            margin-top: 12px;
            display: flex;
            justify-content: center;        
        }        
        .tv-card {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 14px 12px;
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            color: var(--text-primary);
            box-shadow: 0 10px 25px rgba(0,0,0,0.35);
        }
        .tv-card strong { display: block; font-size: 1.2rem; margin-top: 4px; }
        .tv-card.gold { background: linear-gradient(135deg, rgba(201, 162, 39, 0.35), rgba(118, 94, 18, 0.5)); border-color: rgba(201, 162, 39, 0.35); }
        .tv-card.green { background: linear-gradient(135deg, rgba(74, 124, 89, 0.35), rgba(40, 74, 51, 0.55)); border-color: rgba(74, 124, 89, 0.35); }
        .tv-card.purple { background: linear-gradient(135deg, rgba(156, 39, 176, 0.3), rgba(74, 20, 140, 0.55)); border-color: rgba(156, 39, 176, 0.35); }
        .tv-card.blue { background: linear-gradient(135deg, rgba(25, 118, 210, 0.3), rgba(13, 71, 161, 0.6)); border-color: rgba(25, 118, 210, 0.35); }
        .tv-card.steel { background: linear-gradient(135deg, rgba(96, 125, 139, 0.35), rgba(55, 71, 79, 0.6)); border-color: rgba(96, 125, 139, 0.35); }
        .tv-card.ember { background: linear-gradient(135deg, rgba(212, 118, 59, 0.35), rgba(116, 60, 28, 0.6)); border-color: rgba(212, 118, 59, 0.35); }
        .tv-card.sand { background: linear-gradient(135deg, rgba(244, 228, 188, 0.25), rgba(168, 154, 138, 0.5)); border-color: rgba(244, 228, 188, 0.35); color: #fef6e6; }
        .tv-card.shadow { background: linear-gradient(135deg, rgba(61, 50, 42, 0.6), rgba(26, 20, 16, 0.9)); border-color: rgba(255, 255, 255, 0.08); }
        body.epaper-mode .tv-card {
            background: #e6e6e6;
            color: #222;
            border-color: #cfcfcf;
            box-shadow: none;
        }
        .tv-players {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .tv-player {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(0,0,0,0.25);
        }
        .tv-player strong { color: var(--text-primary); }
        .tv-player .tv-chip {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.15);
        }
        .tv-player.white .tv-chip { background: #f5f5f5; }
        .tv-player.black .tv-chip { background: #1c1c1c; }
        body.epaper-mode .tv-player {
            background: #ededed;
            border-color: #cfcfcf;
            color: #333;
        }
        body.epaper-mode .tv-player strong { color: #111; }     
        .tv-section .history-detail-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        .tv-section .history-detail-meta {
            font-size: 0.95rem;
        }
        .tv-section .history-detail-meta strong {
            font-size: 1.05rem;
            color: var(--text-primary);
        }
        .tv-section .tv-players {
            font-size: 0.95rem;
        }
        body.epaper-mode .tv-section .history-detail-title {
            color: #222;
        }        
          #tv-prev {
            background: linear-gradient(135deg, #2f5f44, #254434);
            color: #e6f4ea;
        }
        #tv-play {
            background: linear-gradient(135deg, #3f7a4f, #2f5f44);
            color: #f1fbf4;
        }
        #tv-pause {
            background: linear-gradient(135deg, #5f9b68, #3f7a4f);
            color: #f4fff7;
        }
        #tv-next {
            background: linear-gradient(135deg, #4c8a5a, #336947);
            color: #f0fbf3;
        }
        #history-prev {
            background: linear-gradient(135deg, #2f5f44, #254434);
            color: #e6f4ea;
        }
        #history-play {
            background: linear-gradient(135deg, #3f7a4f, #2f5f44);
            color: #f1fbf4;
        }
        #history-pause {
            background: linear-gradient(135deg, #5f9b68, #3f7a4f);
            color: #f4fff7;
        }
        #history-next {
            background: linear-gradient(135deg, #4c8a5a, #336947);
            color: #f0fbf3;
        }
        #tv-hint {
            background: linear-gradient(135deg, #c3a0f1, #8a63c7);
            color: #fff;
            box-shadow: 0 4px 14px rgba(138, 99, 199, 0.35);
        }
        
        /* BUTTONS */
        .menu-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn {
            font-family: 'Cinzel', serif; font-size: 0.95rem; font-weight: 600; padding: 14px 18px;
            border: none; border-radius: 10px; cursor: pointer; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 10px; letter-spacing: 1px;
        }
               body.epaper-mode .btn {
            background: #dcdcdc !important;
            color: #222 !important;
            border: 1px solid #cfcfcf !important;
            box-shadow: none !important;
        }
        body.epaper-mode .btn:hover { background: #d0d0d0 !important; }
        .btn:active { transform: scale(0.98); }
        .btn[disabled],
        .btn.btn-disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
            filter: grayscale(0.35);
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent-gold) 0%, #a68522 100%); color: var(--bg-dark); }
        .btn-secondary { background: linear-gradient(135deg, var(--accent-green) 0%, #3a6347 100%); color: var(--accent-cream); }
        .btn-blue { background: linear-gradient(135deg, var(--accent-blue) 0%, #0d47a1 100%); color: white; }
        
        body.device-tablet .menu-buttons,
        body.device-desktop .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        
        .btn-hint {
            background: linear-gradient(135deg, #7b1fa2, #4a148c);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #c62828, #8b0000);
            color: white;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.4);
        }
        
        .sync-container { display: flex; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; }
        .btn-file {
            background: var(--bg-warm); color: var(--text-secondary); font-family: 'Crimson Pro', serif;
            font-size: 0.8rem; padding: 10px; flex: 1; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
        }
        .btn-share { background: linear-gradient(135deg, #673ab7, #9c27b0); color: white; width: 100%; margin-bottom: 5px; display: none; font-weight: bold; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 16px; text-align: center; width: 100%; max-width: 380px; border: 1px solid rgba(201, 162, 39, 0.3); max-height: 80vh; overflow-y: auto; }
        body.epaper-mode .modal-overlay { background: rgba(0,0,0,0.15); }
        body.epaper-mode .modal-content { background: #e6e6e6; border: 1px solid #cfcfcf; color: #222; }
        
        .modal-title { font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--accent-gold); margin-bottom: 15px; }
        .close-modal { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--text-secondary); padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-family: 'Crimson Pro', serif; }
        
        .new-badge { width: 80px; height: 80px; font-size: 3.5rem; margin: 0 auto 15px; }
        .new-badge-name { font-size: 1.3rem; color: var(--text-primary); margin-bottom: 5px; font-weight: bold; }
        .new-badge-stars { color: var(--star-gold); font-size: 1rem; }
        
        #badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 15px; }
        .badge-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .badge-item.locked { opacity: 0.4; }
        .badge-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .badge-name { font-size: 0.8rem; color: var(--text-primary); margin-bottom: 3px; }
        .badge-req { font-size: 0.65rem; color: var(--text-secondary); }
        
        /* BUNDLE & DRILLS MENU */
        .bundle-list { text-align: left; max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .bundle-item, .drill-item {
            background: rgba(0,0,0,0.2); padding: 12px; margin-bottom: 8px; border-radius: 8px;
            border-left: 4px solid var(--severity-low); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drill-item { border-left-color: var(--accent-blue); }
        .bundle-item.med { border-left-color: var(--severity-med); }
        .bundle-item.high { border-left-color: var(--severity-high); }
        .bundle-item:hover, .drill-item:hover { background: rgba(255,255,255,0.05); }
        .bundle-meta { font-size: 0.75rem; color: var(--text-secondary); }
        .bundle-elo { color: var(--accent-gold); font-weight: bold; }
        .bundle-remove { color: #8b3a3a; cursor: pointer; padding: 5px 10px; font-size: 0.9rem; }
        .bundle-remove:hover { color: #c62828; }
        
        /* BUNDLE FOLDERS */
        .bundle-folder-list { text-align: left; margin-top: 10px; }
        .bundle-section {
            border: 1px solid rgba(201, 162, 39, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.18);
        }
        .bundle-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            background: rgba(0,0,0,0.25);
        }
        .bundle-section-title {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            letter-spacing: 1px;
            color: var(--text-primary);
        }
        .bundle-section-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bundle-section-caret { opacity: 0.8; }
        .bundle-section-content { padding: 8px 10px; display: none; }
        .bundle-section.open .bundle-section-content { display: block; }

        .bundle-section.low .bundle-section-header {
            border-left: 4px solid var(--severity-low);
            background: var(--severity-low);
        }
        .bundle-section.med .bundle-section-header {
            border-left: 4px solid var(--severity-med);
            background: var(--severity-med);
        }
        .bundle-section.high .bundle-section-header {
            border-left: 4px solid var(--severity-high);
            background: var(--severity-high);
        }
        .bundle-section.low .bundle-section-title,
        .bundle-section.low .bundle-section-count,
        .bundle-section.med .bundle-section-title,
        .bundle-section.med .bundle-section-count {
            color: #2d241c;
        }
        .bundle-section.high .bundle-section-title,
        .bundle-section.high .bundle-section-count {
            color: #fff7e1;
        }
        .bundle-section.drill .bundle-section-header { border-left: 4px solid var(--accent-blue); }

        .bundle-empty {
            padding: 10px 12px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* GAME SCREEN */
        #game-screen { display: none; }
        .header { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .header-title { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--accent-gold); margin-bottom: 8px; }
        .game-info { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary); }
        .streak-badge { color: var(--star-gold); font-weight: bold; }
        
        .precision-panel { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .precision-stat { text-align: center; min-width: 70px; }
        .precision-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 3px; }
        .precision-value { font-family: 'Cinzel', serif; font-size: 1.3rem; font-weight: 700; color: var(--accent-gold); }
        .precision-target-text { color: var(--text-secondary); }
        
        .precision-bar-container { flex: 1; height: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; position: relative; overflow: hidden; }
        .precision-bar { height: 100%; background: var(--accent-green); border-radius: 10px; width: 0%; transition: width 0.3s, background 0.3s; }
        .precision-bar.warning { background: var(--severity-med); }
        .precision-bar.danger { background: var(--severity-high); }
        .calibration-progress {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        .calibration-progress-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .calibration-progress-bar {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
        }
        .calibration-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-purple);
            transition: width 0.3s ease;
        }
        #calibration-result-screen {
            width: 100%;
            max-width: 980px;
            margin: 0 auto;
            display: none;
            padding: 20px 16px 40px;
            color: var(--text-primary);
        }
        .calibration-result-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .calibration-result-header h1 {
            margin: 8px 0 6px;
            font-size: 1.8rem;
        }
        .calibration-result-elo {
            font-size: 1.4rem;
            color: var(--accent-gold);
        }
        .calibration-wld {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .calibration-result-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            font-weight: bold;
            color: #fff;
            font-size: 0.9rem;
        }
        .calibration-result-badge.win { background: #4a7c59; }
        .calibration-result-badge.loss { background: #c62828; }
        .calibration-result-badge.draw { background: #607d8b; }
        .calibration-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .calibration-summary-card {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-soft);
        }
        .calibration-summary-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1rem;
            color: var(--accent-gold);
        }
        .calibration-chart-container {
            height: 220px;
        }
        .status-message.elo-reveal {
            animation: pulse-purple 1.2s ease-in-out 2;
        }        
        .precision-target { position: absolute; left: 75%; top: 0; width: 2px; height: 100%; background: rgba(255,255,255,0.5); }
        
        .board-container { position: relative; margin-bottom: 15px; }
        .blunder-alert {
            position: absolute; top: 10px; right: 10px; width: 45px; height: 45px; background: var(--severity-high);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 58, 58, 0.6); cursor: pointer; z-index: 100; animation: blunder-pulse 1s infinite;
        }
        .blunder-alert.alert-low { background: var(--severity-low); box-shadow: 0 4px 15px var(--severity-low); }
        .blunder-alert.alert-med { background: var(--severity-med); box-shadow: 0 4px 15px var(--severity-med); }
        .blunder-alert.alert-high { background: var(--severity-high); box-shadow: 0 4px 15px var(--severity-high); }
        .bundle-success-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.75);
            display: none; align-items: center; justify-content: center; z-index: 150; padding: 16px;
        }
        .bundle-success-content {
            background: rgba(45, 36, 28, 0.95);
            border: 1px solid rgba(201, 162, 39, 0.4);
            border-radius: 14px;
            padding: 18px 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
            width: 100%;
            max-width: 340px;
        }
        .bundle-success-icon {
            font-size: 3rem;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 12px rgba(74, 124, 89, 0.6));
        }
        .bundle-success-title { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 1.2rem; margin-bottom: 8px; }
        .bundle-success-remaining { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 14px; }
        .bundle-success-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .bundle-success-actions .btn { flex: 1; min-width: 150px; }
        
        .league-banner {
            margin: 12px 0;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(201, 162, 39, 0.12), rgba(74, 124, 89, 0.15));
            border: 1px solid rgba(201, 162, 39, 0.35);
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
            color: var(--text-primary);
            cursor: pointer;
        }
        .league-banner.disabled {
            opacity: 0.45;
            pointer-events: none;
            cursor: not-allowed;
        }
        .league-banner:hover { box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
        .league-banner-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
            font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 1rem; letter-spacing: 1px;
        }
        .league-banner-quote { color: var(--text-secondary); font-style: italic; font-size: 0.85rem; margin-bottom: 10px; }
        .league-banner-body { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .league-banner-opponent {
            font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 8px;
        }
        .league-badge { padding: 4px 8px; border-radius: 10px; background: rgba(0,0,0,0.25); font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.08); }
        .league-banner-ranks { display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.9rem; color: var(--text-secondary); }
        .league-banner-actions { margin-top: 10px; display: flex; justify-content: flex-end; }
        .league-banner-actions .btn { width: 100%; max-width: 220px; }
        
        @keyframes blunder-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .controls { background: var(--bg-card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .status-message { color: var(--text-primary); font-size: 0.95rem; margin-bottom: 12px; text-align: center; min-height: 24px; }
        .game-buttons { display: flex; gap: 8px; }
        .game-buttons .btn { flex: 1; padding: 12px 10px; font-size: 0.85rem; }

        /* STATS SCREEN */
        #stats-screen { text-align: left; }
  
        .history-section {
            margin-top: 20px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-radius: 12px;
            padding: 14px;
        }
        body.epaper-mode .history-section {
            background: var(--bg-card);
            border: 1px solid #cfcfcf;
        }
        .history-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }
        .history-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        body.device-desktop .history-layout,
        body.device-tablet .history-layout {
            grid-template-columns: 1fr 1fr;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 360px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: rgba(0,0,0,0.25);
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(201, 162, 39, 0.15);
            flex-wrap: wrap;        
        }
        body.epaper-mode .history-item {
            background: #eaeaea;
            border-color: #cfcfcf;
        }
        .history-item-main {
            flex: 1 1 180px;
        }
        .history-item-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .history-item-actions .btn {
            padding: 8px 10px;
            font-size: 0.8rem;
        }        
        .history-item-title { font-weight: 600; font-size: 0.95rem; }
        .history-item-meta { font-size: 0.75rem; color: var(--text-secondary); }
        .history-empty { color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 12px; }
        .history-detail {
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(201, 162, 39, 0.15);
        }
        body.epaper-mode .history-detail {
            background: #ededed;
            border-color: #cfcfcf;
        }
        body.device-desktop .history-detail {
            display: grid;
            grid-template-columns: 1fr 1.1fr;
            grid-template-rows: auto auto auto auto auto;
            gap: 10px 14px;
        }
        body.device-desktop .history-detail-header {
            grid-column: 1 / -1;
        }
        body.device-desktop .history-review {
            grid-column: 1;
            grid-row: 2 / span 4;
            align-self: start;
        }
        body.device-desktop .history-board {
            grid-column: 2;
        }
        body.device-desktop .history-controls,
        body.device-desktop .history-actions,
        body.device-desktop .history-progress {
            grid-column: 2;
        }
        .history-detail-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }
        .history-detail-title { font-size: 1rem; font-weight: 600; }
        .history-detail-meta { font-size: 0.8rem; color: var(--text-secondary); }
        .history-board {
            width: 100%;
            max-width: 360px;
            margin: 10px auto 12px;
        }
.history-review {
            background: rgba(0,0,0,0.18);
            border-radius: 10px;
            padding: 12px 14px;
            border: 1px solid rgba(201, 162, 39, 0.12);
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        body.epaper-mode .history-review {
            background: #ededed;
            border-color: #cfcfcf;
        }
        .history-review-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 8px;
        }
        body.epaper-mode .history-review-title { color: #222; }
        .history-review-content {
            font-size: 1.15rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            line-height: 1.6;
        }
        body.epaper-mode .history-review-content { color: #444; }
        #history-board {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(201, 162, 39, 0.3);
        }
                #tv-board {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(201, 162, 39, 0.3);
            margin: 0 auto;
        }
        body.epaper-mode #history-board { border-color: #cfcfcf; }
        body.epaper-mode #tv-board { border-color: #cfcfcf; }
        .history-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .history-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }
        .history-actions .btn {
            max-width: 240px;
        }
        .history-progress {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .tv-section .history-board {
            max-width: 640px;
            position: relative;
        }
        #tv-screen .settings-panel {
            text-align: center;
        }
        body.device-mobile .tv-section .history-board {
            max-width: none;
            width: 100vw;
            margin: 10px calc(50% - 50vw) 12px;
        }     
                .tv-section {
            margin-top: 18px;
        }
        .tv-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            min-height: 1.1em;
        }
        .tv-jeroglyphics-turn {
            margin-top: 12px;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
            display: none;
        }
        .tv-jeroglyphics-overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: rgba(10, 10, 10, 0.35);
            z-index: 3;
        }      
        .tv-jeroglyphics-result {
            padding: 14px 16px;
            max-width: 320px;
            border-radius: 12px;
            border: 2px solid rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.12);
            text-align: center;
            display: none;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
        }
        .tv-jeroglyphics-result--incorrect {
            border-color: rgba(244, 67, 54, 0.6);
            background: rgba(244, 67, 54, 0.12);       
        }
        .tv-jeroglyphics-result-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }
        .tv-jeroglyphics-result-text {
            font-weight: 700;
            margin-bottom: 8px;
        }
        .tv-jeroglyphics-result-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .tv-end-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .stats-header { text-align: center; margin-bottom: 20px; }
        
        .chart-container {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            text-align: center;
        }
        
        #elo-chart { max-height: 250px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-card-value {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
            font-weight: 700;
        }
        
        .stat-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
               .review-legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
        }
        .review-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-primary);
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            min-width: 130px;
            justify-content: space-between;
        }
            body.epaper-mode .review-chip {
            background: #e6e6e6;
            border: 1px solid #cfcfcf;
            color: #222;
        }
        .review-chip strong { color: white; font-size: 1rem; }
        .review-chip.excel { border-color: rgba(74, 124, 89, 0.4); color: #cbe6d2; }
        .review-chip.good { border-color: rgba(201, 162, 39, 0.4); color: #f4e4bc; }
        .review-chip.inaccuracy { border-color: rgba(255, 183, 77, 0.4); color: #ffe4c4; }
        .review-chip.mistake { border-color: rgba(239, 83, 80, 0.4); color: #ffd1d1; }
        .review-chip.blunder { border-color: rgba(183, 28, 28, 0.4); color: #ffcdd2; }
        .review-highlight {
            text-align: center;
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .danger-zone {
            background: rgba(139, 58, 58, 0.2);
            border: 1px solid rgba(139, 58, 58, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        body.epaper-mode .danger-zone { background: #e6e6e6; border: 1px solid #cfcfcf; }
        
        .danger-zone-title {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: #c62828;
            margin-bottom: 10px;
            text-align: center;
        }
        body.epaper-mode .danger-zone-title { color: #444; }
        
        .confirm-delete {
            display: none;
            background: rgba(198, 40, 40, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        body.epaper-mode .confirm-delete { background: #efefef; border: 1px solid #cfcfcf; }
        
        .confirm-delete p {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .confirm-buttons { display: flex; gap: 8px; }
        .confirm-buttons .btn { flex: 1; padding: 10px; font-size: 0.85rem; }

        /* Lliga */
        .league-meta {
            background: var(--bg-warm);
            padding: 12px 14px;
            border-radius: 14px;
            margin-top: 12px;
            border: 1px solid rgba(201, 162, 39, 0.12);
        }
        .league-name { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .league-round, .league-next, .league-note { color: var(--text-secondary); margin-top: 4px; font-size: 0.95rem; }
        .league-note { font-size: 0.9rem; }

        .league-table-wrap {
            margin-top: 12px;
            background: var(--bg-warm);
            border-radius: 14px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            border: 1px solid rgba(201, 162, 39, 0.12);
        }
        table.league-table { width: 100%; border-collapse: collapse; }
        .league-table thead th {
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 10px 10px;
            background: rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(201, 162, 39, 0.12);
        }
        .league-table tbody td {
            padding: 10px 10px;
            border-bottom: 1px solid rgba(201, 162, 39, 0.08);
            font-size: 0.95rem;
        }
        .league-table tbody td.league-player-cell {
            text-align: left;
        }
        .league-elo-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
            font-size: 0.88rem;
        }
        body.epaper-mode .league-table thead th {
            background: #e6e6e6;
            border-bottom: 1px solid #cfcfcf;
        }
        body.epaper-mode .league-table tbody td { border-bottom: 1px solid #cfcfcf; }      
        .league-table tbody tr:last-child td { border-bottom: none; }
        .league-table tbody td.num { text-align: right; font-variant-numeric: tabular-nums; }
        .league-table thead th.num { text-align: right; }
        .league-row-me .league-player-name { color: var(--accent-gold); font-weight: 700; }
        .league-podium-1 { background: rgba(255, 215, 0, 0.14); }
        .league-podium-2 { background: rgba(192, 192, 192, 0.10); }
        .league-podium-3 { background: rgba(205, 127, 50, 0.10); }

        /* Lliga responsive mobile */
        table.league-table { min-width: 520px; }
        .league-table thead th:last-child {
            position: sticky;
            right: 0;
            z-index: 5;
            background: rgba(61, 50, 42, 0.98);
            box-shadow: -10px 0 14px rgba(0,0,0,0.25);
        }
        .league-table tbody td:last-child {
            position: sticky;
            right: 0;
            z-index: 4;
            background: rgba(61, 50, 42, 0.98);
            box-shadow: -10px 0 14px rgba(0,0,0,0.18);
        }
        body.epaper-mode .league-table thead th:last-child,
        body.epaper-mode .league-table tbody td:last-child {
            background: #e6e6e6;
            box-shadow: none;
        }
        
        body.epaper-mode .league-table tbody td { border-bottom: 1px solid #cfcfcf; }
        @media (max-width: 520px) {
            body { padding: 0; align-items: flex-start; }
            #app-container { max-width: 100vw; width: 100vw; }
            #game-screen { padding: 0 0 10px; }
            .header, .precision-panel, .controls { margin-left: 8px; margin-right: 8px; border-radius: 12px; }
            .header { padding: 10px; margin-top: 8px; margin-bottom: 8px; }
            .header-title { font-size: 1.05rem; margin-bottom: 6px; }
            .game-info { font-size: 0.78rem; gap: 6px; }
            .precision-panel { padding: 10px; gap: 10px; margin-bottom: 8px; }
            .precision-stat { min-width: 56px; }
            .precision-value { font-size: 1.15rem; }
            .board-container { margin: 0; }
            #myBoard { width: 100vw; max-width: 100vw; }
            .controls { padding: 10px; margin-top: 8px; }
            .status-message { font-size: 0.9rem; margin-bottom: 10px; }
            .game-buttons .btn { padding: 12px 8px; font-size: 0.82rem; }
            table.league-table { min-width: 520px; }
            .league-table thead th, .league-table tbody td { padding: 8px 6px; }
            .league-table thead th { font-size: 0.74rem; }
            .league-table tbody td { font-size: 0.86rem; }
        }

        @media (max-width: 900px) and (orientation: landscape) and (max-height: 520px) {
            body.device-mobile { padding: 0; align-items: flex-start; }
            body.device-mobile #app-container { max-width: 100vw; width: 100vw; }
            body.device-mobile #game-screen { padding: 0 0 8px; }
            body.device-mobile .header, body.device-mobile .precision-panel, body.device-mobile .controls { margin-left: 8px; margin-right: 8px; }
            body.device-mobile .header { padding: 8px 10px; margin-top: 6px; margin-bottom: 6px; }
            body.device-mobile .precision-panel { padding: 8px 10px; gap: 10px; margin-bottom: 6px; }
            body.device-mobile .controls { padding: 8px 10px; margin-top: 6px; }
            body.device-mobile .board-container { margin: 0; }
            body.device-mobile #myBoard { width: 100vw; max-width: 100vw; }
        }

        body.device-desktop #game-screen {
            display: grid;
            grid-template-columns: minmax(520px, 1fr) 320px;
            gap: 16px;
            align-items: start;
        }
        body.device-desktop .header {
            grid-column: 2;
            grid-row: 1;
        }
        body.device-desktop .precision-panel {
            grid-column: 2;
            grid-row: 2;
        }
        body.device-desktop .board-container {
            grid-column: 1;
            grid-row: 1 / span 3;
            margin-bottom: 0;
        }
        body.device-desktop .controls {
            grid-column: 2;
            grid-row: 3;
        }

        /* Controls del tauler (tocar / arrossegar) */
        body.control-tap #myBoard { touch-action: manipulation; }
        body.control-drag #myBoard { touch-action: none; }
        #myBoard, #myBoard * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        /* Tap-to-move feedback */
        .board-container { width: 100%; }
        .square-55d63.tap-selected { outline: 3px solid rgba(201, 162, 39, 0.95); outline-offset: -3px; }
        .square-55d63.tap-move { box-shadow: inset 0 0 0 3px rgba(74, 124, 89, 0.65); }
        .square-55d63.engine-move {
            border-radius: 10px;
            box-shadow: inset 0 0 0 3px #4b2f18 !important;
            outline: none !important;
        }
        
        /* PWA Install Banner */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 1000;
            text-align: center;
        }
        .install-banner.show { display: block; }
        .install-banner button { margin-top: 8px; }

        /* Revisió de partides */
        .review-modal-result {
            font-size: 1.05rem;
            color: var(--accent-gold);
            margin-bottom: 8px;
            font-family: 'Cinzel', serif;
        }
        .review-precision {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .checkmate-image {
            display: none;
            width: min(220px, 70%);
            margin: 4px auto 12px;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.35));
        }
        #checkmate-overlay .modal-content {
            background: transparent;
            box-shadow: none;
            padding: 0;
            border: none;
        }
        #checkmate-overlay .checkmate-image {
            display: block;
            margin: 0 auto;
        }        
        .review-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="start-screen">
            <div class="app-logo">♔</div>
            <h1>EL TAULER</h1>
            <div class="subtitle">Entrenador d'Escacs</div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">ELO</div>
                    <div class="stat-value elo-value" id="current-elo">400</div>
                </div>
                <div class="stat-box" id="streak-box">
                    <div class="stat-label">Ratxa</div>
                    <div class="stat-value streak-value" id="current-streak">0</div>
                    <div class="streak-status" id="streak-status">Pendent</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Estrelles</div>
                    <div class="stat-value stars-value" id="current-stars">0</div>
                </div>
            </div>
            
            <div class="missions-panel">
                <div class="missions-header">
                    <div class="missions-title">Missions Diàries</div>
                    <button class="badges-btn" id="btn-badges">Trofeus</button>
                </div>
                <div id="missions-list"></div>
            </div>
            
            <div class="menu-buttons">
                <button class="btn btn-primary" id="btn-new-game">♟ Nova Partida</button>
                <div class="league-banner" id="league-banner" style="display:none;">
                    <div class="league-banner-header">
                        <span>🏅 Proper partit de lliga</span>
                        <span class="league-badge" id="league-banner-opp-rank">#—</span>
                    </div>
                    <div class="league-banner-quote" id="league-banner-quote">Preparat per brillar?</div>
                    <div class="league-banner-body">
                        <div class="league-banner-opponent">vs <span id="league-banner-opponent">—</span> · ELO <span id="league-banner-elo">—</span></div>
                        <div class="league-banner-ranks">
                            <span class="league-badge">Tu: <span id="league-banner-my-rank">#—</span></span>
                            <span class="league-badge">Si guanyes: <span id="league-banner-projected">#—</span></span>
                        </div>
                    </div>
                    <div class="league-banner-actions">
                        <button class="btn btn-primary" id="btn-league-banner-play" style="margin-top:8px;">🎯 Jugar ara</button>
                    </div>
                </div>
                <button class="btn btn-secondary" id="btn-league" style="background: linear-gradient(135deg, #8d6e63 0%, #5d4037 100%); color: #f4e4bc;">🏆 Lliga</button>
                <button class="btn btn-secondary" id="btn-bundle-menu" style="background: linear-gradient(135deg, #8b8076 0%, #60564d 100%); color: #f4e4bc;">
                    📚 Revisa Errors
                    <span style="font-size:0.75rem; opacity:0.8;" id="bundle-info">Cap error desat</span>
                </button>
                <button class="btn btn-secondary" id="btn-history" style="background: linear-gradient(135deg, #6d7b87 0%, #47515a 100%); color: white;">📜 Historial</button>
                <button class="btn btn-secondary" id="btn-stats" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); color: white;">📊 Estadístiques</button>
            </div>
            
            <div class="sync-container">
                <button class="btn btn-share" id="btn-smart-share">📤 Compartir Progrés</button>
                <button class="btn btn-file" id="btn-export">💾 Exportar</button>
                <button class="btn btn-file" id="btn-import">📂 Importar</button>
                <input type="file" id="file-input" accept=".json" style="display:none;">
            </div>
        </div>

        <div id="calibration-result-screen" style="display:none;">
            <div class="calibration-result-header">
                <div class="app-logo">🎯</div>
                <h1>Resultats del calibratge</h1>
                <div class="calibration-result-elo" id="calibration-elo-value">—</div>
                <div class="calibration-wld">
                    <span id="calibration-wld-summary">W 0 · L 0 · D 0</span>
                </div>
                <div class="calibration-wld" id="calibration-wld-row"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Evolució del nivell</div>
                <div class="calibration-chart-container">
                    <canvas id="calibration-chart"></canvas>
                </div>
            </div>

            <div class="calibration-summary-grid">
                <div class="calibration-summary-card">
                    <h3>Punts forts</h3>
                    <ul id="calibration-strengths"></ul>
                </div>
                <div class="calibration-summary-card">
                    <h3>Punts febles</h3>
                    <ul id="calibration-weaknesses"></ul>
                </div>
            </div>

            <div style="margin-top: 24px; text-align:center;">
                <button class="btn btn-primary" id="btn-calibration-continue">Començar partides normals</button>
            </div>
        </div>

        <div id="stats-screen" style="display:none;">
            <div class="stats-header">
                <div class="app-logo">📊</div>
                <h1>Estadístiques</h1>
            </div>
            
            <div class="settings-panel">
                <div class="settings-title">Configuració</div>
                <div class="setting-row">
                    <div class="setting-label">Lliga</div>
                    <button class="btn btn-secondary" id="btn-reset-league">Reiniciar lliga</button>
                </div>
                <div class="setting-help">Genera una nova lliga segons el teu ELO actual.</div>
                <div class="setting-row">
                    <div class="setting-label">Control del tauler</div>
                    <select id="control-mode-select" class="select-control">
                        <option value="tap">Tocar</option>
                        <option value="drag">Arrossegar</option>
                    </select>
                </div>
                <div class="setting-help">Al mòbil sol anar millor "Tocar". Si vols més estil chess.com, prova "Arrossegar".</div>
                <div class="setting-row">
                    <div class="setting-label">Revisió d'errors (Bundle)</div>
                    <select id="bundle-accept-select" class="select-control">
                        <option value="top1">Només la millor</option>
                        <option value="top2">Només les dues millors</option>
                    </select>
                </div>
                <div class="setting-row">
                    <div class="setting-label">Mode ePaper</div>
                    <label class="epaper-toggle">
                        <input type="checkbox" id="epaper-toggle">
                        <span class="epaper-slider"></span>
                    </label>
                </div>
                <div class="setting-help">Tons grisos, ombres mínimes i sense animacions per llegir millor.</div>
                <div class="setting-row">
                    <div class="setting-label">Calibratge inicial</div>
                    <button class="btn btn-secondary" id="btn-recalibrate">Tornar a calibrar nivell</button>
                </div>
                <div class="setting-help">Això resetarà el teu perfil actual.</div>
                <div class="setting-row" style="margin-top:10px;">
                    <div class="setting-label">Clau API Gemini (gemini-3-flash-preview)</div>
                    <div class="setting-inline">
                        <input type="password" id="gemini-key-input" class="text-input" placeholder="Enganxa la clau">
                        <button class="btn btn-secondary" id="btn-save-gemini-key">Guardar</button>
                    </div>
                    <div class="setting-status" id="gemini-key-status">—</div>
                </div>
                <div class="setting-help">La clau queda guardada i les revisions de partides es generen automàticament.</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Progressió de l'ELO</div>
                <canvas id="elo-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Qualitat de jugades</div>
                <div class="review-legend">
                    <div class="review-chip excel">Excel·lents <strong id="legend-excel">0</strong></div>
                    <div class="review-chip good">Bones <strong id="legend-good">0</strong></div>
                    <div class="review-chip inaccuracy">Imprecisions <strong id="legend-inaccuracy">0</strong></div>
                    <div class="review-chip mistake">Errors <strong id="legend-mistake">0</strong></div>
                    <div class="review-chip blunder">Blunders <strong id="legend-blunder">0</strong></div>
                </div>
                <div style="height:240px;">
                    <canvas id="review-chart"></canvas>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-value" id="stats-total-games">0</div>
                    <div class="stat-card-label">Partides Jugades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="stats-total-wins">0</div>
                    <div class="stat-card-label">Victòries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="stats-bundles-count">0</div>
                    <div class="stat-card-label">Errors Guardats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="stats-max-streak">0</div>
                    <div class="stat-card-label">Millor Ratxa</div>
                </div>
            </div>

            <div class="danger-zone">
                <div class="danger-zone-title">⚠️ Zona Perillosa</div>
                <button class="btn btn-danger" id="btn-show-delete" style="width:100%;">
                    🗑️ Esborrar Totes les Dades
                </button>
                
                <div class="confirm-delete" id="confirm-delete-panel">
                    <p><strong>ATENCIÓ:</strong> Aquesta acció esborrarà totes les teves dades, incloent-hi l'ELO, errors guardats, ratxa, missions i trofeus. Aquesta acció NO es pot desfer.</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-secondary" id="btn-cancel-delete">Cancel·lar</button>
                        <button class="btn btn-danger" id="btn-confirm-delete">Confirmar</button>
                    </div>
                </div>
            </div>
            
            <div class="menu-buttons" style="margin-top:20px;">
                <button class="btn btn-primary" id="btn-back-stats">Tornar al Menú</button>
            </div>
        </div>
   
        <div id="history-screen" style="display:none;">
            <div class="stats-header">
                <div class="app-logo">📜</div>
                <h1>Historial</h1>
            </div>
            <div class="history-section">
                <div class="history-title">Partides guardades</div>
                <div class="history-layout">
                    <div class="history-list" id="history-list"></div>
                    <div class="history-detail">
                        <div class="history-detail-header">
                            <div class="history-detail-title" id="history-result">—</div>
                            <div class="history-detail-meta" id="history-meta">Selecciona una partida per veure detalls.</div>
                            <div class="history-detail-meta">Precisió: <strong id="history-precision">—</strong></div>
                        </div>
                        <div class="review-legend" id="history-breakdown"></div>
                        <div class="history-board">
                            <div id="history-board"></div>
                        </div>
                        <div class="history-controls">
                            <button class="btn btn-secondary" id="history-prev">⏮️ Endarrere</button>
                            <button class="btn btn-primary" id="history-play">▶️ Play</button>
                            <button class="btn btn-secondary" id="history-pause">⏸️ Pausa</button>
                            <button class="btn btn-secondary" id="history-next">⏭️ Endavant</button>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-secondary" id="history-generate-review">✨ Generar ressenya</button>
                        </div>
                        <div class="history-review">
                            <div class="history-review-title">Historial revisió</div>
                            <div class="history-review-content" id="history-review-content">—</div>
                        </div>
                        <div class="history-progress" id="history-progress">0/0</div>
                    </div>
                </div>
            </div>
            <div class="menu-buttons" style="margin-top:20px;">
                <button class="btn btn-primary" id="btn-back-history">Tornar al Menú</button>
            </div>
        </div>

        <div class="modal-overlay" id="badges-modal">
            <div class="modal-content">
                <div class="modal-title">🏆 Trofeus</div>
                <div style="margin-bottom:15px; color:var(--text-secondary);">
                    Total Estrelles: <span style="color:var(--star-gold); font-weight:bold;" id="modal-total-stars">0</span>
                </div>
                <div id="badges-grid"></div>
                <button class="close-modal" onclick="$('#badges-modal').hide()">Tancar</button>
            </div>
        </div>
        
        <div class="modal-overlay" id="new-badge-modal">
            <div class="modal-content">
                <div class="modal-title">🎉 Trofeu Desbloquejat!</div>
                <div class="new-badge" id="new-badge-icon">🏆</div>
                <div class="new-badge-name" id="new-badge-name">Master</div>
                <div class="new-badge-stars" id="new-badge-stars">★★★</div>
                <button class="btn btn-primary" onclick="$('#new-badge-modal').hide()">Genial!</button>
            </div>
        </div>
        <div class="modal-overlay" id="checkmate-overlay">
            <div class="modal-content">
                <img src="checkmate.svg" alt="Escac i mat" class="checkmate-image">
            </div>
        </div>
        <div class="modal-overlay" id="review-modal">
            <div class="modal-content">
                <div class="modal-title">📈 Revisió de la partida</div>
                <img src="checkmate.svg" alt="Escac i mat" id="checkmate-image" class="checkmate-image">
                <div class="review-modal-result" id="review-result-text">—</div>
                <div class="review-precision">Precisió final: <strong id="review-precision-value">—</strong></div>
                <div class="review-highlight">Com han estat les teves jugades?</div>
                <div class="review-legend" id="review-breakdown"></div>
                <div class="review-actions">
                    <button class="btn btn-secondary" id="btn-review-errors">🔍 Revisar errors</button>
                    <button class="btn btn-primary" id="btn-review-stats">📊 Veure evolució</button>
                    <button class="btn btn-secondary" id="btn-review-menu">Menú</button>
                    <button class="close-modal" id="btn-review-close">Tancar</button>
                </div>
            </div>
        </div>
        
        <div id="league-screen" style="display:none;">
            <div class="stats-header">
                <div class="app-logo">🏆</div>
                <h1>Lliga</h1>
            </div>

            <div class="league-meta">
                <div class="league-name" id="league-name">—</div>
                <div class="league-round" id="league-round">Jornada 1/9</div>
                <div class="league-next" id="league-next">Proper rival: —</div>
                <div class="league-note">Punts: Victòria 1 · Taules 0,5 · Derrota 0</div>
            </div>

            <div class="league-table-wrap">
                <table class="league-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th class="num">ELO</th>
                            <th>PJ</th>
                            <th>PG</th>
                            <th>PP</th>
                            <th>PE</th>
                            <th>Punts</th>
                        </tr>
                    </thead>
                    <tbody id="league-table-body"></tbody>
                </table>
            </div>

            <div class="menu-buttons" style="margin-top:16px;">
                <button class="btn btn-primary" id="btn-league-play">Jugar</button>
                <button class="btn btn-secondary" id="btn-league-new" style="display:none;">Generar nova lliga</button>
                <button class="btn btn-secondary" id="btn-back-league">Tornar al Menú</button>
            </div>
        </div>

        <div id="game-screen">
            <div class="header">
                <div class="header-title" id="game-mode-title">♞ En joc</div>
                <div class="game-info">
                    <div>Tu: <span id="game-elo" style="color:var(--accent-gold); font-weight:bold;">400</span></div>
                    <div>IA: <span id="engine-elo" style="color:var(--accent-purple); font-weight:bold;">Adaptativa</span></div>
                    <div>📚 <span id="game-bundles" style="color:var(--text-secondary); font-weight:bold;">0</span></div>
                    <div class="streak-badge">★ <span id="game-stars">0</span></div>
                </div>
                <div class="calibration-progress" id="calibration-progress">
                    <div class="calibration-progress-text" id="calibration-progress-text">Calibrant... Partida 1/5</div>
                    <div class="calibration-progress-bar">
                        <div class="calibration-progress-fill" id="calibration-progress-fill"></div>
                    </div>
                </div>            
            </div>
            
            <div class="precision-panel">
                <div class="precision-stat">
                    <div class="precision-label">Precisió</div>
                    <div class="precision-value" id="current-precision">—</div>
                </div>
                <div class="precision-bar-container">
                    <div class="precision-bar" id="precision-bar"></div>
                    <div class="precision-target" id="precision-target"></div>
                </div>
                <div class="precision-stat">
                    <div class="precision-label">Objectiu</div>
                    <div class="precision-value precision-target-text">75%</div>
                </div>
            </div>
   
            <div class="board-container">
                <div id="myBoard"></div>
                <div class="bundle-success-overlay" id="bundle-success-overlay">
                    <div class="bundle-success-content">
                        <div class="bundle-success-icon">✅</div>
                        <div class="bundle-success-title">Bundle resolt</div>
                        <div class="bundle-success-remaining">Bundles pendents</div>
                        <div class="bundle-success-actions">
                            <button class="btn btn-primary" id="btn-bundle-random-again">🎲 Un altre</button>
                            <button class="btn btn-secondary" id="btn-bundle-random-home">🏠 Tornar</button>
                        </div>
                    </div>
                </div> 
                <div class="bundle-success-overlay" id="bundle-category-success-overlay">
                    <div class="bundle-success-content">
                        <div class="bundle-success-icon">✅</div>
                        <div class="bundle-success-title">Error resolt</div>
                        <div class="bundle-success-remaining">Queden errors d'aquesta categoria</div>
                        <div class="bundle-success-actions">
                            <button class="btn btn-primary" id="btn-bundle-category-again">➡️ Un altre d'aquesta categoria</button>
                            <button class="btn btn-secondary" id="btn-bundle-category-home">📚 Tornar a Revisa Errors</button>
                            <button class="btn btn-secondary" id="btn-bundle-category-menu">🏠 Tornar al menú</button>                      
                        </div>
                    </div>
                </div>           
                <div class="blunder-alert" id="blunder-alert" title="Desfés l'error (click)">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="white">
                        <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
                    </svg>
                </div>
            </div>
            
            <div class="controls">
                <div class="status-message" id="status">Preparat...</div>
                <div class="game-buttons">
                    <button class="btn btn-hint" id="btn-hint" title="Demanar pista">💡 Pista</button>
                    <button class="btn btn-secondary" id="btn-back">Menú</button>
                    <button class="btn btn-primary" id="btn-resign">Rendir-se</button>
                </div>
            </div>
   
        </div>
    </div>

    <div class="modal-overlay" id="menu-exit-modal">
        <div class="modal-content">
            <div class="modal-title">Sortir de la partida?</div>
            <div class="subtitle" id="menu-exit-message">Vols sortir de la partida?</div>
            <div class="resign-modal-actions">
                <button class="btn btn-primary" id="btn-menu-exit-confirm">Sí</button>
                <button class="btn btn-secondary" id="btn-menu-exit-cancel">No</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resign-modal">
        <div class="modal-content">
            <div class="modal-title">Rendir-se?</div>
            <div class="resign-modal-actions">
                <button class="btn btn-primary" id="btn-resign-confirm">Sí</button>
                <button class="btn btn-secondary" id="btn-resign-cancel">No</button>
            </div>
        </div>
    </div>
    
    <!-- PWA Install Banner -->
    <div class="install-banner" id="install-banner">
        <div style="color: var(--text-primary); margin-bottom: 8px;">📲 Instal·la El Tauler al teu dispositiu</div>
        <button class="btn btn-primary" id="btn-install" style="padding: 10px 20px;">Instal·lar</button>
        <button class="btn btn-file" id="btn-dismiss-install" style="padding: 10px 15px; margin-left: 8px;">Ara no</button>
    </div>

    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- App Logic -->
    <script>
        window.APP_VERSION = '1.0.4';
    </script>
    <script src="app.js?v=1.0.4"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => {
                        console.log('Service Worker registrat:', reg.scope);
                        if (reg.waiting) {
                            reg.waiting.postMessage('skipWaiting');
                        }
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            if (!newWorker) return;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    newWorker.postMessage('skipWaiting');
                                }
                            });
                        });
                    })
                    .catch((err) => console.log('Error registrant SW:', err));
            });
              let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
        }
    </script>
</body>
</html>
